<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Financeira PRO | Lançamentos</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Icons Library -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PDF.js Library for reading PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .view, .modal { display: none; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #formContainer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- LOADING/LOGIN VIEW -->
    <div id="loadingView" class="flex items-center justify-center min-h-screen bg-slate-200">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg text-center">
            <h1 class="text-3xl font-bold text-center text-indigo-600">Gestão PRO</h1>
            <div id="loaderContainer" class="flex flex-col items-center justify-center space-y-4">
                <div class="loader"></div>
                <p class="text-slate-600">Conectando ao servidor...</p>
            </div>
             <div id="loginContainer" class="hidden">
                <p class="text-slate-600 mb-4">Acesse o sistema para gerenciar seus lançamentos.</p>
                <button id="loginButton" class="w-full py-3 font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                    Acessar
                </button>
                 <p class="text-xs text-slate-500 mt-4">Usando autenticação anônima do Firebase.</p>
            </div>
            <p id="loginError" class="text-sm text-center text-red-500 hidden"></p>
        </div>
    </div>

    <!-- MAIN APP VIEW -->
    <div id="appView" class="hidden">
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-8">
                        <h1 class="text-2xl font-bold text-indigo-600">Gestão PRO</h1>
                        <nav class="hidden md:flex space-x-4">
                            <a href="#" class="nav-link text-indigo-600 border-b-2 border-indigo-600 px-1 py-4 text-sm font-medium" data-view="dashboardView">Dashboard</a>
                            <a href="#" class="nav-link text-slate-500 hover:text-slate-700 px-1 py-4 text-sm font-medium" data-view="lancamentosListView">Lançamentos</a>
                        </nav>
                    </div>
                    <div class="flex items-center">
                         <span class="text-sm text-slate-600 mr-4">Usuário: <span id="userId" class="font-medium"></span></span>
                        <button id="logoutButton" class="text-slate-500 hover:text-indigo-600">
                             <i data-lucide="log-out" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div id="dashboardView" class="view"></div>
            <div id="lancamentosListView" class="view"></div>
            <div id="lancamentoDetailView" class="view"></div>
        </main>
    </div>

    <!-- Modals -->
    <div id="alertModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm"><h3 id="alertModalTitle" class="text-lg font-medium"></h3><p id="alertModalMessage" class="mt-2 text-sm text-slate-600"></p><div class="mt-4 flex justify-end"><button id="alertModalCloseButton" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">OK</button></div></div></div>
    <div id="confirmModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm"><div class="flex items-start"><div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10"><i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i></div><div class="ml-4 text-left"><h3 id="confirmModalTitle" class="text-lg font-medium"></h3><p id="confirmModalMessage" class="mt-2 text-sm text-slate-600"></p></div></div><div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse"><button id="confirmModalConfirmButton" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm">Confirmar</button><button id="confirmModalCancelButton" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">Cancelar</button></div></div></div>
    <div id="progressModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md"><h3 id="progressModalTitle" class="text-lg font-medium text-center"></h3><div class="mt-4 space-y-2"><p id="progressFileName" class="text-sm text-center text-slate-600 truncate"></p><div class="w-full bg-gray-200 rounded-full h-2.5"><div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div></div><p id="progressCounter" class="text-sm text-center font-medium text-slate-800"></p></div><div id="progressErrorContainer" class="mt-4 max-h-32 overflow-y-auto"></div><div class="mt-4 flex justify-end hidden" id="progressCloseBtnContainer"><button id="progressCloseBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Fechar</button></div></div></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDoc, setDoc, deleteDoc, onSnapshot, query, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAHq-utRHf-rDVJ9YtNdD8PCIRvboGqLuI",
            authDomain: "gestor-pro-51706.firebaseapp.com",
            projectId: "gestor-pro-51706",
            storageBucket: "gestor-pro-51706.appspot.com",
            messagingSenderId: "519113320151",
            appId: "1:519113320151:web:d22638842180572b9338fd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let lancamentosUnsubscribe = null;
        let allLancamentosData = [];
        const DEFAULT_COMISSION_RATE = 0.05; 
        let currentPage = 1;
        const ITEMS_PER_PAGE = 15;
        let dashboardChart = null;

        let selectedMonthFilter = null;
        let selectedYearFilter = null;

        const loadingView = document.getElementById('loadingView');
        const loaderContainer = document.getElementById('loaderContainer');
        const loginContainer = document.getElementById('loginContainer');
        const loginButton = document.getElementById('loginButton');
        const appView = document.getElementById('appView');
        const allViews = document.querySelectorAll('.view');
        const navLinks = document.querySelectorAll('.nav-link');
        const userIdEl = document.getElementById('userId');

        const formatCurrency = (value) => `R$ ${Number(value || 0).toFixed(2).replace('.', ',').replace(/(\d)(?=(\d{3})+,)/g, '$1.')}`;
        const getGiroTotal = (l) => l.valorTotal ?? ((l.valorMaterial || 0) + (l.valorServico || 0));

        const createDashboardHTML = (lancamentos) => {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const faturadosNoMes = lancamentos.filter(l => {
                const faturadoDate = l.faturado?.toDate();
                return faturadoDate && faturadoDate.getMonth() === currentMonth && faturadoDate.getFullYear() === currentYear;
            });

            const faturamentoMes = faturadosNoMes.reduce((sum, l) => sum + getGiroTotal(l), 0);
            const comissoesMes = faturadosNoMes.reduce((sum, l) => sum + (l.comissao || 0), 0);
            const giroTotalMes = lancamentos
                .filter(l => {
                    const emissaoDate = l.dataEmissao?.toDate();
                    return emissaoDate && emissaoDate.getMonth() === currentMonth && emissaoDate.getFullYear() === currentYear;
                })
                .reduce((sum, l) => sum + getGiroTotal(l), 0);

            return `<h2 class="text-2xl font-bold mb-6">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow"><div class="flex items-center"><div class="bg-blue-100 p-3 rounded-full"><i data-lucide="trending-up" class="w-6 h-6 text-blue-600"></i></div><div class="ml-4"><p class="text-sm text-slate-500">Giro Total do Mês</p><p class="text-2xl font-bold">${formatCurrency(giroTotalMes)}</p></div></div></div>
                    <div class="bg-white p-6 rounded-lg shadow"><div class="flex items-center"><div class="bg-green-100 p-3 rounded-full"><i data-lucide="dollar-sign" class="w-6 h-6 text-green-600"></i></div><div class="ml-4"><p class="text-sm text-slate-500">Faturamento do Mês</p><p class="text-2xl font-bold">${formatCurrency(faturamentoMes)}</p></div></div></div>
                    <div class="bg-white p-6 rounded-lg shadow"><div class="flex items-center"><div class="bg-yellow-100 p-3 rounded-full"><i data-lucide="percent" class="w-6 h-6 text-yellow-600"></i></div><div class="ml-4"><p class="text-sm text-slate-500">Comissões do Mês</p><p class="text-2xl font-bold">${formatCurrency(comissoesMes)}</p></div></div></div>
                </div>
                <div class="mt-8 bg-white p-6 rounded-lg shadow">
                     <h3 class="text-lg font-medium mb-4">Desempenho dos Últimos 6 Meses</h3>
                     <div class="relative h-96">
                        <canvas id="dashboardChart"></canvas>
                     </div>
                </div>`;
        };
        
        const createNovoLancamentoFormHTML = () => `
            <form id="novoLancamentoForm" class="bg-white p-6 rounded-lg shadow space-y-4">
                <h3 class="text-lg font-medium">Novo Lançamento</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                    <div><label class="block text-sm font-medium text-slate-700">Data Emissão</label><input type="date" id="newDataEmissao" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                    <div><label class="block text-sm font-medium text-slate-700">Cliente</label><input type="text" id="newCliente" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" list="client-list"></div>
                    <div><label class="block text-sm font-medium text-slate-700">Nº NF</label><input type="text" id="newNumeroNf" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                    <div><label class="block text-sm font-medium text-slate-700">O.S/PC</label><input type="text" id="newOs" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2"><label class="block text-sm font-medium text-slate-700">Motor</label><input type="text" id="newDescricao" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                    <div><label class="block text-sm font-medium text-slate-700">Valor Total</label><input type="number" step="0.01" id="newValorTotal" value="0" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                     <div class="md:col-span-2"><label class="block text-sm font-medium text-slate-700">Observação</label><textarea id="newObs" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea></div>
                     <div><label class="block text-sm font-medium text-slate-700">Taxa de Comissão (%)</label><input type="number" step="0.01" id="newTaxaComissao" value="${DEFAULT_COMISSION_RATE}" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                </div>
                <div class="flex justify-end pt-4 border-t">
                    <button type="button" id="cancelNewLancamento" class="bg-white py-2 px-4 border border-slate-300 rounded-md shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50">Cancelar</button>
                    <button type="submit" class="ml-3 inline-flex items-center justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Salvar Lançamento</button>
                </div>
            </form>
            <datalist id="client-list"></datalist>
        `;

        const createLancamentosListHTML = () => `
            <div class="space-y-6">
                <div class="flex space-x-4">
                    <button id="toggleFormBtn" class="w-full flex justify-center items-center py-3 px-4 border-2 border-dashed border-slate-300 rounded-lg text-slate-600 hover:bg-slate-200 hover:border-slate-400 transition-colors">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Adicionar Lançamento Manual
                    </button>
                    <button id="analiseIaBtn" class="w-full flex justify-center items-center py-3 px-4 bg-indigo-100 text-indigo-700 border-2 border-dashed border-indigo-300 rounded-lg hover:bg-indigo-200 hover:border-indigo-400 transition-colors font-semibold">
                        <i data-lucide="scan-line" class="w-5 h-5 mr-2"></i> Analisar NF com IA
                    </button>
                    <input type="file" id="nfUploadInput" class="hidden" accept="application/pdf">
                </div>
                <div id="formContainer"></div>
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl font-bold">Histórico de Lançamentos</h2>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <label for="monthFilter" class="text-sm font-medium">Mês:</label>
                            <select id="monthFilter" class="rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="yearFilter" class="text-sm font-medium">Ano:</label>
                            <select id="yearFilter" class="rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                    </div>
                </div>
                <div class="bg-white shadow overflow-x-auto sm:rounded-lg">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Data Emissão</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Cliente</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">NF</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">O.S/PC</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Giro Total</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Comissão</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Faturado</th>
                                <th class="relative px-6 py-3"><span class="sr-only">Ações</span></th>
                            </tr>
                        </thead>
                        <tbody id="lancamentosTableBody" class="bg-white divide-y divide-slate-200"></tbody>
                    </table>
                </div>
                <div id="pagination-controls" class="flex justify-between items-center text-sm"></div>
                <div class="mt-8 bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-medium mb-4">Exportar Relatório</h3>
                    <div class="flex space-x-4">
                         <button id="exportPdfBtn" class="bg-slate-700 hover:bg-slate-800 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                            <i data-lucide="printer" class="w-4 h-4 mr-2"></i>
                            Imprimir / Salvar PDF
                        </button>
                        <button id="exportCsvBtn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4 mr-2"></i>
                            Exportar para CSV (Excel)
                        </button>
                    </div>
                </div>
            </div>`;

        const createLancamentosTableRowsHTML = (lancamentos) => {
            if (!lancamentos.length) return '<tr><td colspan="8" class="text-center py-10 text-slate-500">Nenhum lançamento encontrado para o período selecionado.</td></tr>';
            return lancamentos.map(l => {
                const giroTotal = getGiroTotal(l);
                return `
                <tr class="hover:bg-slate-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${l.dataEmissao?.toDate().toLocaleDateString('pt-BR')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${l.cliente}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${l.numeroNf}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${l.os || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${formatCurrency(giroTotal)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${formatCurrency(l.comissao)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
                        <div class="flex items-center">
                            <button data-id="${l.firestoreId}" class="faturado-toggle cursor-pointer relative inline-flex items-center h-6 rounded-full w-11 transition-colors ${l.faturado ? 'bg-green-500' : 'bg-gray-200'}">
                                <span class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform ${l.faturado ? 'translate-x-6' : 'translate-x-1'}"></span>
                            </button>
                            <span class="ml-2">${l.faturado ? l.faturado.toDate().toLocaleDateString('pt-BR') : 'Pendente'}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button class="text-indigo-600 hover:text-indigo-900 view-details" data-id="${l.firestoreId}">Editar</button></td>
                </tr>`;
            }).join('');
        };
        
        const createLancamentoDetailHTML = (lancamento) => {
            const valorTotal = getGiroTotal(lancamento);
            return `
            <button class="back-to-list flex items-center text-sm text-indigo-600 hover:text-indigo-800 font-medium mb-6"><i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> Voltar para a lista</button>
            <form id="editLancamentoForm" data-id="${lancamento.firestoreId}" class="bg-white p-8 rounded-lg shadow max-w-4xl mx-auto space-y-6">
                <h2 class="text-2xl font-bold">Editar Lançamento</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div><label class="block text-sm font-medium text-slate-700">Data Emissão</label><input type="date" id="editDataEmissao" value="${lancamento.dataEmissao.toDate().toISOString().split('T')[0]}" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                    <div><label class="block text-sm font-medium text-slate-700">Cliente</label><input type="text" id="editCliente" value="${lancamento.cliente}" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                    <div><label class="block text-sm font-medium text-slate-700">Nº NF</label><input type="text" id="editNumeroNf" value="${lancamento.numeroNf}" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                    <div><label class="block text-sm font-medium text-slate-700">O.S/PC</label><input type="text" id="editOs" value="${lancamento.os || ''}" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2"><label class="block text-sm font-medium text-slate-700">Motor</label><input type="text" id="editDescricao" value="${lancamento.descricao}" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                    <div><label class="block text-sm font-medium text-slate-700">Valor Total</label><input type="number" step="0.01" id="editValorTotal" value="${valorTotal}" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                     <div class="md:col-span-2"><label class="block text-sm font-medium text-slate-700">Observação</label><textarea id="editObs" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">${lancamento.obs || ''}</textarea></div>
                      <div><label class="block text-sm font-medium text-slate-700">Taxa de Comissão (%)</label><input type="number" step="0.01" id="editTaxaComissao" value="${lancamento.taxaComissao || DEFAULT_COMISSION_RATE}" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                </div>
                <div class="flex justify-end pt-4 border-t">
                    <button type="button" id="deleteLancamentoBtn" class="text-red-600 hover:underline mr-auto">Excluir Lançamento</button>
                    <button type="submit" class="inline-flex items-center justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Salvar Alterações</button>
                </div>
            </form>`;
        };
        
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                userIdEl.textContent = user.uid.substring(0, 8) + '...';
                loadingView.style.display = 'none';
                appView.style.display = 'block';
                attachLancamentosListener();
            } else {
                currentUser = null;
                appView.style.display = 'none';
                loadingView.style.display = 'flex';
                loaderContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                if (lancamentosUnsubscribe) lancamentosUnsubscribe();
            }
        });

        loginButton.addEventListener('click', () => {
            loaderContainer.classList.remove('hidden');
            loginContainer.classList.add('hidden');
            signInAnonymously(auth).catch(error => {
                showAlertModal('Erro de Autenticação', error.message);
                loaderContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
            });
        });

        logoutButton.addEventListener('click', () => signOut(auth));

        function attachLancamentosListener() {
            if (lancamentosUnsubscribe) lancamentosUnsubscribe();
            const q = query(collection(db, 'lancamentos'));
            lancamentosUnsubscribe = onSnapshot(q, (querySnapshot) => {
                allLancamentosData = querySnapshot.docs.map(doc => ({ firestoreId: doc.id, ...doc.data() }));
                const currentViewEl = document.querySelector('.view[style*="block"]');
                const viewId = currentViewEl ? currentViewEl.id : 'dashboardView';
                showView(viewId);
            }, (error) => {
                showAlertModal("Erro de Conexão", "Não foi possível carregar os lançamentos.");
            });
        }
        
        const renderView = (viewId, data) => {
            const viewContainer = document.getElementById(viewId);
            let html = '';
            switch (viewId) {
                case 'dashboardView': html = createDashboardHTML(data); break;
                case 'lancamentosListView': html = createLancamentosListHTML(); break;
                case 'lancamentoDetailView': html = createLancamentoDetailHTML(data); break;
            }
            viewContainer.innerHTML = html;
            lucide.createIcons();
        }
        
        const showView = async (viewId, dataId = null) => {
            allViews.forEach(v => v.style.display = 'none');
            const viewContainer = document.getElementById(viewId);
            viewContainer.style.display = 'block';
            
            if (viewId === 'lancamentoDetailView' && dataId) {
                viewContainer.innerHTML = `<div class="flex items-center justify-center h-96"><div class="loader"></div></div>`;
                lucide.createIcons();
                
                const docRef = doc(db, "lancamentos", dataId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    renderView(viewId, { firestoreId: docSnap.id, ...docSnap.data() });
                } else {
                    showAlertModal("Erro", "Lançamento não encontrado."); 
                    showView('lancamentosListView');
                }
            } else {
                 renderView(viewId, allLancamentosData);
            }

            if (viewId === 'lancamentosListView') {
                populateFiltersAndApply();
            } else if (viewId === 'dashboardView') {
                renderDashboardChart(allLancamentosData);
            }
            
            navLinks.forEach(link => {
                const isActive = link.dataset.view === viewId;
                link.classList.toggle('text-indigo-600', isActive);
                link.classList.toggle('border-b-2', isActive);
                link.classList.toggle('border-indigo-600', isActive);
                link.classList.toggle('text-slate-500', !isActive);
            });
        }

        function populateFiltersAndApply() {
            const monthFilter = document.getElementById('monthFilter');
            const yearFilter = document.getElementById('yearFilter');
            if (!monthFilter || !yearFilter) return;

            if(selectedMonthFilter === null) {
                selectedMonthFilter = new Date().getMonth();
                selectedYearFilter = new Date().getFullYear();
            }

            if (monthFilter.options.length <= 1) {
                const months = ["Todos", "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                monthFilter.innerHTML = months.map((month, index) => `<option value="${index - 1}">${month}</option>`).join('');
            }
            
            const years = [...new Set(allLancamentosData.map(l => l.dataEmissao?.toDate().getFullYear()).filter(Boolean))];
            years.sort((a, b) => b - a);
            if (!years.includes(new Date().getFullYear())) {
                years.unshift(new Date().getFullYear());
            }
            yearFilter.innerHTML = `<option value="-1">Todos</option>` + years.map(year => `<option value="${year}">${year}</option>`).join('');
            
            monthFilter.value = selectedMonthFilter;
            yearFilter.value = selectedYearFilter;

            applyFilters();

            monthFilter.onchange = () => { selectedMonthFilter = parseInt(monthFilter.value, 10); currentPage = 1; applyFilters(); };
            yearFilter.onchange = () => { selectedYearFilter = parseInt(yearFilter.value, 10); currentPage = 1; applyFilters(); };
        }
        
        function applyFilters() {
            const tableBody = document.getElementById('lancamentosTableBody');
            if(!tableBody) return;

            const filteredData = getFilteredData();
            
            const totalPages = Math.ceil(filteredData.length / ITEMS_PER_PAGE);
            currentPage = Math.min(currentPage, totalPages) || 1;

            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const paginatedData = filteredData.slice(start, end);

            tableBody.innerHTML = createLancamentosTableRowsHTML(paginatedData);
            renderPaginationControls(filteredData.length, totalPages);
            lucide.createIcons();
        }
        
        function renderPaginationControls(totalItems, totalPages) {
            const container = document.getElementById('pagination-controls');
            if (!container) return;

            container.innerHTML = `
                <div>
                    <p class="text-sm text-gray-700">
                        Mostrando
                        <span class="font-medium">${Math.min((currentPage - 1) * ITEMS_PER_PAGE + 1, totalItems)}</span>
                        a
                        <span class="font-medium">${Math.min(currentPage * ITEMS_PER_PAGE, totalItems)}</span>
                        de
                        <span class="font-medium">${totalItems}</span>
                        resultados
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <button id="prev-page" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                            Anterior
                        </button>
                        <button id="next-page" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                            Próximo
                        </button>
                    </nav>
                </div>
            `;
            const prevButton = document.getElementById('prev-page');
            const nextButton = document.getElementById('next-page');

            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages || totalItems === 0;

            prevButton.onclick = () => { if (currentPage > 1) { currentPage--; applyFilters(); } };
            nextButton.onclick = () => { if (currentPage < totalPages) { currentPage++; applyFilters(); } };
        }

        function getFilteredData() {
            if (selectedMonthFilter === null) {
                selectedMonthFilter = new Date().getMonth();
                selectedYearFilter = new Date().getFullYear();
            }

            return allLancamentosData.filter(l => {
                const date = l.dataEmissao?.toDate();
                if (!date) return false;
                const monthMatch = selectedMonthFilter === -1 || date.getMonth() === selectedMonthFilter;
                const yearMatch = selectedYearFilter === -1 || date.getFullYear() === selectedYearFilter;
                return monthMatch && yearMatch;
            });
        }
        
        function generatePrintReport() {
            const filtered = getFilteredData();
            if (filtered.length === 0) {
                showAlertModal('Aviso', 'Não há dados para exportar com os filtros selecionados.');
                return;
            }
            
            const monthName = document.getElementById('monthFilter').options[document.getElementById('monthFilter').selectedIndex].text;
            const yearName = document.getElementById('yearFilter').options[document.getElementById('yearFilter').selectedIndex].text;
            const title = `Relatório de Lançamentos: ${monthName} ${yearName}`;
            
            let reportHTML = `
                <html>
                <head>
                    <title>${title}</title>
                    <style>
                        body { font-family: sans-serif; margin: 1cm; color: #333; }
                        h1 { font-size: 18px; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; font-size: 10px; }
                        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .summary { margin-top: 20px; border-top: 2px solid #333; padding-top: 10px; font-size: 12px; }
                        h2 { font-size: 16px; }
                         @media print {
                            body { -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
            `;

            const totalGiro = filtered.reduce((sum, l) => sum + getGiroTotal(l), 0);
            const totalComissao = filtered.reduce((sum, l) => sum + (l.comissao || 0), 0);

            reportHTML += `
                <table>
                    <thead>
                        <tr>
                            <th>Data</th><th>Cliente</th><th>NF</th><th>O.S/PC</th><th>Motor</th><th>Valor Total</th><th>Comissão</th><th>Faturado</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filtered.sort((a, b) => a.dataEmissao.toDate() - b.dataEmissao.toDate()).forEach(l => {
                reportHTML += `
                    <tr>
                        <td>${l.dataEmissao?.toDate().toLocaleDateString('pt-BR')}</td>
                        <td>${l.cliente || '-'}</td>
                        <td>${l.numeroNf || '-'}</td>
                        <td>${l.os || ''}</td>
                        <td>${l.descricao || '-'}</td>
                        <td>${formatCurrency(getGiroTotal(l))}</td>
                        <td>${formatCurrency(l.comissao)}</td>
                        <td>${l.faturado ? l.faturado.toDate().toLocaleDateString('pt-BR') : 'Pendente'}</td>
                    </tr>
                `;
            });

            reportHTML += `
                    </tbody>
                </table>
                <div class="summary">
                    <h2>Resumo do Período</h2>
                    <p><strong>Total Lançado (Giro):</strong> ${formatCurrency(totalGiro)}</p>
                    <p><strong>Total em Comissões:</strong> ${formatCurrency(totalComissao)}</p>
                </div>
                <script>
                    window.onload = function() {
                        window.print();
                    }
                <\/script>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '', 'height=800,width=800');
            printWindow.document.write(reportHTML);
            printWindow.document.close();
        }

        function generateCsvReport() {
            const filtered = getFilteredData();
             if (filtered.length === 0) {
                showAlertModal('Aviso', 'Não há dados para exportar com os filtros selecionados.');
                return;
            }

            const head = ['Data Emissao', 'Cliente', 'NF', 'OS/PC', 'Motor', 'Valor Total', 'Comissao', 'Faturado', 'Data Faturamento'];
            const body = filtered.map(l => [
                l.dataEmissao?.toDate().toLocaleDateString('pt-BR'),
                `"${(l.cliente || '').replace(/"/g, '""')}"`,
                l.numeroNf || '-',
                `"${(l.os || '').replace(/"/g, '""')}"`,
                `"${(l.descricao || '').replace(/"/g, '""')}"`,
                getGiroTotal(l).toFixed(2).replace('.',','),
                (l.comissao || 0).toFixed(2).replace('.',','),
                l.faturado ? 'Sim' : 'Nao',
                l.faturado ? l.faturado.toDate().toLocaleDateString('pt-BR') : ''
            ]);

            const csvContent = "data:text/csv;charset=utf-8," 
                + head.join(';') + '\n' 
                + body.map(e => e.join(';')).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "relatorio_lancamentos.csv");
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link);
        }

        function renderDashboardChart(lancamentos) {
            const chartCtx = document.getElementById('dashboardChart')?.getContext('2d');
            if (!chartCtx) return;

            const labels = [];
            const faturamentoData = [];
            const comissaoData = [];

            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const month = date.toLocaleString('pt-BR', { month: 'short' });
                const year = date.getFullYear();
                labels.push(`${month.charAt(0).toUpperCase() + month.slice(1)}/${year}`);
                
                const faturadosNoMes = lancamentos.filter(l => {
                    const faturadoDate = l.faturado?.toDate();
                    return faturadoDate && faturadoDate.getMonth() === date.getMonth() && faturadoDate.getFullYear() === year;
                });

                faturamentoData.push(faturadosNoMes.reduce((sum, l) => sum + getGiroTotal(l), 0));
                comissaoData.push(faturadosNoMes.reduce((sum, l) => sum + l.comissao, 0));
            }

            if(dashboardChart) {
                dashboardChart.destroy();
            }

            dashboardChart = new Chart(chartCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Faturamento',
                            data: faturamentoData,
                            backgroundColor: 'rgba(79, 70, 229, 0.8)',
                            borderColor: 'rgba(79, 70, 229, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Comissão',
                            data: comissaoData,
                            backgroundColor: 'rgba(251, 191, 36, 0.8)',
                            borderColor: 'rgba(251, 191, 36, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        appView.addEventListener('click', async (e) => {
            const target = e.target;
            const targetId = target.id;
            const lancamentoForm = target.closest('form');

            const navLink = target.closest('.nav-link');
            if (navLink) { e.preventDefault(); showView(navLink.dataset.view); return; }

            if (target.closest('.view-details')) showView('lancamentoDetailView', target.closest('.view-details').dataset.id);
            else if (target.closest('.back-to-list')) showView('lancamentosListView');
            else if (targetId === 'toggleFormBtn') {
                const formContainer = document.getElementById('formContainer');
                if (formContainer.style.maxHeight) {
                    formContainer.style.maxHeight = null;
                } else {
                    formContainer.innerHTML = createNovoLancamentoFormHTML();
                    formContainer.style.maxHeight = formContainer.scrollHeight + "px";
                    setupNewLancamentoFormListeners();
                }
            }
             else if (targetId === 'analiseIaBtn') {
                document.getElementById('nfUploadInput').click();
            }
            else if (targetId === 'cancelNewLancamento') {
                 const formContainer = document.getElementById('formContainer');
                 formContainer.style.maxHeight = null;
                 setTimeout(() => formContainer.innerHTML = '', 500);
            }
            else if (target.closest('.faturado-toggle')) {
                const toggleButton = target.closest('.faturado-toggle');
                const lancamentoId = toggleButton.dataset.id;
                const lancamento = allLancamentosData.find(l => l.firestoreId === lancamentoId);
                if (lancamento) {
                    const newStatus = lancamento.faturado ? null : new Date();
                    await updateDoc(doc(db, 'lancamentos', lancamentoId), { faturado: newStatus });
                }
            }
            else if (targetId === 'deleteLancamentoBtn' && lancamentoForm) {
                showConfirmModal( 'Excluir Lançamento', 'Tem certeza que deseja excluir este lançamento?',
                    async () => {
                        await deleteDoc(doc(db, "lancamentos", lancamentoForm.dataset.id));
                        showAlertModal('Excluído!', 'O lançamento foi removido.');
                        showView('lancamentosListView');
                    }
                );
            } else if (targetId === 'exportPdfBtn') {
                generatePrintReport();
            } else if (targetId === 'exportCsvBtn') {
                generateCsvReport();
            }
        });
        
        async function extractPdfImage(file) {
            const pdfjsLib = window['pdfjs-dist/build/pdf'];
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
            const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
            const page = await pdf.getPage(1);
            const viewport = page.getViewport({ scale: 1.0 });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext: context, viewport: viewport }).promise;
            return canvas.toDataURL().split(',')[1];
        }

        async function callGeminiForAnalysis(base64ImageData) {
             const apiKey = "";
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
             
             const prompt = `
                Analise a imagem desta Nota Fiscal (NFS-e de serviço de Curitiba ou DANFE de produtos) e extraia as seguintes informações em formato JSON. Seja extremamente preciso:
                1.  **cliente**: Encontre o nome/razão social do "TOMADOR DE SERVIÇOS" (em NFS-e) ou do "DESTINATÁRIO" (em DANFE).
                2.  **dataEmissao**: Encontre a "Data e Hora de Emissão" ou "Data de Emissão" e formate como AAAA-MM-DD.
                3.  **numeroNf**: Encontre o "Número da Nota".
                4.  **valorTotal**: Encontre o "Valor Líquido da Nota Fiscal", "VALOR TOTAL DOS SERVIÇOS" ou "VALOR TOTAL DA NOTA". Extraia apenas o número.
                5.  **os**: Dentro do quadro "DISCRIMINAÇÃO DOS SERVIÇOS" ou "DADOS ADICIONAIS / Informações Complementares", procure por "O.S", "O.S." ou "Ordem de Serviço" e extraia o número que a acompanha. Se não encontrar, deixe em branco.
                6.  **pc**: Dentro dos mesmos campos do item anterior, procure por "PC" ou "Pedido de Compra" e extraia o código que o acompanha (ex: PC172315). Se não encontrar, deixe em branco.
                7.  **observacoes**: Faça um resumo de uma linha (máximo 15 palavras) da "DISCRIMINAÇÃO DOS SERVIÇOS" ou "Natureza da Operação". Ignore listas de peças.
            `;

            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inline_data: { mime_type: "image/png", data: base64ImageData } }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: { "dataEmissao": { "type": "STRING" }, "cliente": { "type": "STRING" }, "numeroNf": { "type": "STRING" }, "os": { "type": "STRING" }, "pc": { "type": "STRING" }, "valorTotal": { "type": "NUMBER" }, "observacoes": { "type": "STRING" } }
                    }
                }
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error("A resposta da API de IA não foi bem-sucedida.");
            }

            const result = await response.json();
            const candidate = result.candidates?.[0];
            const jsonText = candidate?.content?.parts?.[0]?.text;
            if (jsonText) {
                return JSON.parse(jsonText);
            } else {
                throw new Error("A API de IA não retornou dados válidos.");
            }
        }
        
        appView.addEventListener('change', async (e) => {
            if (e.target.id === 'nfUploadInput') {
                const files = e.target.files;
                if (!files.length) return;

                if (files.length === 1) {
                    const file = files[0];
                    showAlertModal('Analisando NF...', 'Lendo o PDF e consultando a IA. Isso pode levar alguns segundos.');
                    try {
                        const imageData = await extractPdfImage(file);
                        const data = await callGeminiForAnalysis(imageData);

                        const formContainer = document.getElementById('formContainer');
                        if (!formContainer.style.maxHeight) {
                             formContainer.innerHTML = createNovoLancamentoFormHTML();
                             formContainer.style.maxHeight = formContainer.scrollHeight + "px";
                             setupNewLancamentoFormListeners();
                        }
                        
                        setTimeout(() => {
                            let os_pc = data.os || '';
                            if (data.pc) { os_pc = os_pc ? `${os_pc} / ${data.pc}` : data.pc; }

                             if (data.dataEmissao) document.getElementById('newDataEmissao').value = data.dataEmissao;
                             if (data.cliente) document.getElementById('newCliente').value = data.cliente;
                             if (data.numeroNf) document.getElementById('newNumeroNf').value = data.numeroNf;
                             if (os_pc) document.getElementById('newOs').value = os_pc;
                             if (data.valorTotal) document.getElementById('newValorTotal').value = data.valorTotal;
                             if (data.observacoes) document.getElementById('newObs').value = data.observacoes;
                             showAlertModal('Sucesso!', 'Dados extraídos da NF. Por favor, revise e salve o lançamento.');
                        }, 500);

                    } catch (error) {
                        showAlertModal('Erro na Análise', `Não foi possível analisar o PDF. Erro: ${error.message}`);
                    } finally {
                        e.target.value = '';
                    }

                } else {
                    const progressModal = document.getElementById('progressModal');
                    const progressTitle = document.getElementById('progressModalTitle');
                    const progressFileName = document.getElementById('progressFileName');
                    const progressBar = document.getElementById('progressBar');
                    const progressCounter = document.getElementById('progressCounter');
                    const progressCloseBtnContainer = document.getElementById('progressCloseBtnContainer');
                    const progressCloseBtn = document.getElementById('progressCloseBtn');
                    const progressErrorContainer = document.getElementById('progressErrorContainer');

                    progressTitle.textContent = 'Analisando Notas Fiscais...';
                    progressFileName.textContent = '';
                    progressBar.style.width = '0%';
                    progressCounter.textContent = `Nota 0 de ${files.length}`;
                    progressErrorContainer.innerHTML = '';
                    progressCloseBtnContainer.classList.add('hidden');
                    progressModal.style.display = 'flex';
                    
                    let successCount = 0;
                    let errorCount = 0;
                    let failedFiles = [];

                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        progressCounter.textContent = `Processando nota ${i + 1} de ${files.length}`;
                        progressFileName.textContent = `Analisando: ${file.name}`;
                        try {
                            const imageData = await extractPdfImage(file);
                            const data = await callGeminiForAnalysis(imageData);
                            
                            let os_pc = data.os || '';
                            if (data.pc) {
                                os_pc = os_pc ? `${os_pc} / ${data.pc}` : data.pc;
                            }

                            const valorTotal = data.valorTotal || 0;
                            const taxaComissao = DEFAULT_COMISSION_RATE;
                            await addDoc(collection(db, "lancamentos"), {
                                dataEmissao: new Date(data.dataEmissao + 'T00:00:00'),
                                cliente: data.cliente,
                                numeroNf: data.numeroNf,
                                os: os_pc,
                                descricao: data.observacoes,
                                valorTotal,
                                taxaComissao,
                                comissao: valorTotal * (taxaComissao / 100),
                                faturado: null,
                                obs: `Analisado por IA a partir de ${file.name}`
                            });
                            successCount++;
                        } catch (error) {
                            console.error(`Erro ao processar ${file.name}:`, error);
                            errorCount++;
                            failedFiles.push(file.name);
                        }
                        progressBar.style.width = `${((i + 1) / files.length) * 100}%`;
                    }
                    
                    progressTitle.textContent = 'Análise Concluída';
                    progressFileName.textContent = `${successCount} sucesso(s), ${errorCount} falha(s).`;
                    if(errorCount > 0){
                        progressErrorContainer.innerHTML = `<p class="text-sm font-bold text-red-600">Arquivos com falha:</p>
                            <ul class="text-xs text-red-500 list-disc list-inside">${failedFiles.map(f => `<li>${f}</li>`).join('')}</ul>`;
                    }

                    progressCloseBtnContainer.classList.remove('hidden');
                    progressCloseBtn.onclick = () => { progressModal.style.display = 'none'; };
                    e.target.value = '';
                }
            }
        });

        function setupNewLancamentoFormListeners() {
            const form = document.getElementById('novoLancamentoForm');
            if (!form) return;

            const clienteInput = document.getElementById('newCliente');
            const submitButton = form.querySelector('button[type="submit"]');

            const clients = [...new Set(allLancamentosData.map(l => l.cliente))];
            const clientList = document.getElementById('client-list');
            clientList.innerHTML = clients.map(c => `<option value="${c}"></option>`).join('');
            
            form.addEventListener('input', () => {
                submitButton.disabled = !form.checkValidity();
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                submitButton.disabled = true;
                
                const dateValue = document.getElementById('newDataEmissao').value;

                try {
                    const valorTotal = parseFloat(document.getElementById('newValorTotal').value) || 0;
                    const taxaComissao = parseFloat(document.getElementById('newTaxaComissao').value) || 0;
                    await addDoc(collection(db, "lancamentos"), {
                        dataEmissao: new Date(dateValue + 'T00:00:00'),
                        cliente: document.getElementById('newCliente').value,
                        numeroNf: document.getElementById('newNumeroNf').value,
                        os: document.getElementById('newOs').value,
                        descricao: document.getElementById('newDescricao').value,
                        valorTotal,
                        taxaComissao,
                        comissao: valorTotal * (taxaComissao / 100),
                        faturado: null,
                        obs: document.getElementById('newObs').value
                    });
                    
                    showView('lancamentosListView');

                } catch (error) { 
                    showAlertModal("Erro", `Não foi possível criar o lançamento. Verifique se todos os campos obrigatórios estão preenchidos. Erro: ${error.message}`);
                    submitButton.disabled = false;
                }
            });
        }
        
        appView.addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            
            if (form.id === 'editLancamentoForm') {
                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                const dateValue = document.getElementById('editDataEmissao').value;
                 try {
                    const valorTotal = parseFloat(document.getElementById('editValorTotal').value) || 0;
                    const taxaComissao = parseFloat(document.getElementById('editTaxaComissao').value) || 0;
                    await updateDoc(doc(db, "lancamentos", form.dataset.id), {
                        dataEmissao: new Date(dateValue + 'T00:00:00'),
                        cliente: document.getElementById('editCliente').value,
                        numeroNf: document.getElementById('editNumeroNf').value,
                        os: document.getElementById('editOs').value,
                        descricao: document.getElementById('editDescricao').value,
                        valorTotal,
                        taxaComissao,
                        comissao: valorTotal * (taxaComissao / 100),
                        obs: document.getElementById('editObs').value,
                        valorMaterial: deleteField(),
                        valorServico: deleteField()
                    });
                    showAlertModal('Sucesso', 'Alterações salvas.');
                    showView('lancamentoDetailView', form.dataset.id)
                } catch (error) { 
                    showAlertModal("Erro", `Não foi possível salvar as alterações. ${error.message}`);
                } finally {
                    submitButton.disabled = false;
                }
            }
        });
        
        const alertModal = document.getElementById('alertModal');
        const showAlertModal = (title, message) => { document.getElementById('alertModalTitle').textContent = title; document.getElementById('alertModalMessage').textContent = message; alertModal.style.display = 'flex'; };
        document.getElementById('alertModalCloseButton').addEventListener('click', () => alertModal.style.display = 'none');
        const confirmModal = document.getElementById('confirmModal'); let confirmCallback = null;
        const showConfirmModal = (title, message, onConfirm) => { document.getElementById('confirmModalTitle').textContent = title; document.getElementById('confirmModalMessage').textContent = message; confirmCallback = onConfirm; confirmModal.style.display = 'flex'; };
        document.getElementById('confirmModalCancelButton').addEventListener('click', () => confirmModal.style.display = 'none');
        document.getElementById('confirmModalConfirmButton').addEventListener('click', () => { if (confirmCallback) confirmCallback(); confirmModal.style.display = 'none'; });
        
    </script>

</body>
</html>
